<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Profile — Time Shop Save</title>

<!-- Favicon (inlined SVG, local-only, no external network required) -->
<link rel="icon" type="image/svg+xml"
      href="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><defs><linearGradient id='g' x1='0' x2='1'><stop offset='0' stop-color='%237b2ff7'/><stop offset='1' stop-color='%23ff6ec7'/></linearGradient></defs><rect width='100' height='100' rx='16' fill='url(%23g)'/><text x='50' y='60' font-family='Inter,Arial,sans-serif' font-weight='800' font-size='28' text-anchor='middle' fill='%23070416'>TSS</text></svg>">
<link rel="apple-touch-icon"
      href="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 120 120'><defs><linearGradient id='g2' x1='0' x2='1'><stop offset='0' stop-color='%237b2ff7'/><stop offset='1' stop-color='%23ff6ec7'/></linearGradient></defs><rect width='120' height='120' rx='20' fill='url(%23g2)'/><text x='60' y='78' font-family='Inter,Arial,sans-serif' font-weight='800' font-size='38' text-anchor='middle' fill='%23070416'>TSS</text></svg>">
<meta name="theme-color" content="#7b2ff7">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700,800&display=swap" rel="stylesheet">
<script src="https://kit.fontawesome.com/a2d9b9f0d4.js" crossorigin="anonymous"></script>
<style>
  :root{
    --bg1:#070416;
    --card-bg: rgba(255,255,255,0.03);
    --muted:rgba(234,243,255,0.65);
    --accent-grad: linear-gradient(90deg,#7b2ff7,#ff6ec7,#2be7ff);
    --text:#eaf3ff;
    --active:#2be72b;
    --danger:#ff4b4b;
    --width-max:1200px;
  }
  html,body{height:100%;margin:0;font-family:Inter,system-ui;background:var(--bg1);color:var(--text)}
  .wrap{max-width:var(--width-max);margin:18px auto;padding:18px}
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
  h1{margin:0;background:var(--accent-grad);-webkit-background-clip:text;color:transparent}
  .layout{display:grid;grid-template-columns:220px 1fr;gap:14px}
  @media(max-width:900px){ .layout{grid-template-columns:1fr} }
  .card{background:var(--card-bg);padding:16px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
  .sidebar .menu{display:flex;flex-direction:column;gap:6px;margin-top:12px}
  .menu button{display:flex;align-items:center;gap:10px;padding:10px;border-radius:8px;border:0;background:transparent;color:var(--muted);cursor:pointer;text-align:left}
  .menu button.active{background:linear-gradient(90deg,rgba(123,47,247,0.12),rgba(43,231,255,0.04));color:var(--text)}
  .avatar{width:92px;height:92px;border-radius:14px;overflow:hidden;border:2px solid rgba(255,255,255,0.06);background:#071126}
  .avatar img{width:100%;height:100%;object-fit:cover}
  .btn{padding:8px 10px;border-radius:8px;border:0;background:var(--accent-grad);color:#071126;font-weight:700;cursor:pointer}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--text)}
  input,select,textarea{padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:var(--text);width:100%}
  .small{font-size:13px;color:var(--muted)}
  .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media(max-width:800px){ .form-grid{grid-template-columns:1fr} }
  .tx-list,.orders-list{max-height:46vh;overflow:auto;padding-right:6px;margin-top:8px}
  label.small { display:block; margin-bottom:6px; color:var(--muted); font-size:13px; }
  .footer-note{margin-top:12px;color:var(--muted);font-size:13px}

  /* bottom navigation (same pattern as explore/orders) */
  .bottom-nav{
    position:fixed;
    bottom:0;
    width:100%;
    display:flex;
    justify-content:space-around;
    background:rgba(7,4,22,0.9);
    padding:8px 0;
    border-top:1px solid rgba(255,255,255,0.05);
    backdrop-filter:blur(10px);
    z-index:15;
  }
  .bottom-nav a{
    display:flex;
    flex-direction:column;
    align-items:center;
    font-size:12px;
    color:var(--muted);
    text-decoration:none;
  }
  .bottom-nav a.active{ color:var(--accent-grad); font-weight:600; }
  .bottom-nav i{ font-size:18px; margin-bottom:2px; }

  /* accessible sr-only helper */
  .sr-only { position: absolute !important; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0; }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Customer Profile</h1>
  </header>

  <div class="layout">
    <aside class="card sidebar">
      <div style="display:flex;gap:12px;align-items:center">
        <div class="avatar" id="avatarWrap"><img id="avatarImg" src="https://via.placeholder.com/92?text=You" alt="avatar"></div>
        <div>
          <div id="uName" style="font-weight:800">User</div>
          <div class="small" id="uEmail">you@example.com</div>
        </div>
      </div>

      <div class="menu" role="navigation" aria-label="Profile menu">
        <button id="menuProfile" class="active">Profile Settings</button>
        <button id="menuWallet">Wallet & Top-up</button>
        <button id="menuOrders">Orders</button>
        <button id="menuSecurity">Security</button>
      </div>

      <div style="margin-top:14px">
        <div class="small">Quick actions</div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn ghost" id="profileExportBtn">Export Profile</button>
        </div>
      </div>
    </aside>

    <main>
      <div class="card" id="mainCard">
        <!-- PROFILE -->
        <section id="profileSection">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div style="font-weight:800;font-size:18px">Profile Settings</div>
              <div class="small">Update personal details and preferred display currency</div>
            </div>
            <div><button class="btn" id="saveProfileBtnTop">Save changes</button></div>
          </div>

          <hr style="border:none;border-top:1px solid rgba(255,255,255,0.03);margin:12px 0">

          <div class="form-grid">
            <div>
              <label class="small">First name</label>
              <input id="firstName" placeholder="First name">
            </div>
            <div>
              <label class="small">Last name</label>
              <input id="lastName" placeholder="Last name">
            </div>

            <div>
              <label class="small">Email</label>
              <input id="emailField" placeholder="email@example.com" disabled>
            </div>
            <div>
              <label class="small">Phone</label>
              <input id="phoneField" placeholder="07..." >
            </div>

            <div>
              <label class="small">Country</label>
              <input id="countryField" placeholder="Kenya">
            </div>
            <div>
              <label class="small">Timezone</label>
              <input id="tzField" placeholder="Africa/Nairobi">
            </div>
          </div>

          <div style="margin-top:12px;display:flex;gap:8px">
            <button class="btn" id="saveProfileBtn">Save Changes</button>
            <button class="btn ghost" id="deleteProfileBtn">Delete Account</button>
          </div>

          <div class="footer-note">Display currency is separate from top-up currency. Changing display currency converts your stored balance into the new currency instantly.</div>
        </section>

        <!-- WALLET -->
        <section id="walletSection" style="display:none; margin-top:12px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div style="font-weight:800;font-size:18px">Wallet & Top-up</div>
              <div class="small">Your balance and top-up options</div>
            </div>
          </div>

          <hr style="border:none;border-top:1px solid rgba(255,255,255,0.03);margin:12px 0">

          <div style="display:flex;gap:12px;align-items:center">
            <div>
              <div class="small">Balance</div>
              <div style="font-weight:800;font-size:20px" id="balanceDisplay">Ksh 0.00</div>
              <div class="small" id="convertedSmall">—</div>
            </div>

            <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
              <div>
                <label class="small">Display currency</label>
                <select id="displayCurrency">
                  <option value="KSH">KSH</option>
                  <option value="USD">USD</option>
                  <option value="EUR">EUR</option>
                  <option value="GBP">GBP</option>
                </select>
              </div>

              <div>
                <label class="small">Top-up currency</label>
                <select id="topupCurrency">
                  <option value="KSH">KSH</option>
                  <option value="USD">USD</option>
                  <option value="EUR">EUR</option>
                  <option value="GBP">GBP</option>
                </select>
              </div>
            </div>
          </div>

          <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
            <input id="topupAmount" type="number" placeholder="Amount to add">
            <button class="btn" id="topupBtn">Top up</button>
            <button class="btn ghost" id="devTopupBtn">DEV top-up</button>
          </div>

          <div class="muted" style="margin-top:8px">Platform fee: 5% on top-ups and order payments (recorded for admin only).</div>

          <div style="margin-top:12px">
            <div class="small">Transactions</div>
            <div id="txList" class="tx-list"></div>
          </div>
        </section>

        <!-- ORDERS -->
        <section id="ordersSection" style="display:none; margin-top:12px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div style="font-weight:800;font-size:18px">Orders</div>
              <div class="small">Your recent orders and statuses</div>
            </div>
            <div><button class="btn ghost" id="refreshOrdersBtn">Refresh</button></div>
          </div>

          <div id="ordersList" class="orders-list"></div>
        </section>

        <!-- SECURITY -->
        <section id="securitySection" style="display:none; margin-top:12px">
          <div style="font-weight:800">Security</div>
          <div class="small" style="margin-top:8px">Change password and device sessions</div>
          <div style="margin-top:12px;display:grid;grid-template-columns:1fr 1fr;gap:12px">
            <div>
              <label class="small">New password</label>
              <input id="newPassword" type="password" placeholder="New password">
            </div>
            <div>
              <label class="small">Confirm password</label>
              <input id="confirmPassword" type="password" placeholder="Confirm password">
            </div>
          </div>
          <div style="margin-top:12px"><button class="btn" id="changePwBtn">Change password</button></div>
        </section>
      </div>
    </main>
  </div>
</div>

<!-- bottom nav to match other pages -->
<div class="bottom-nav" aria-hidden="false">
  <a href="index.html"><i class="fas fa-home"></i>Home</a>
  <a href="explore.html"><i class="fas fa-compass"></i>Explore</a>
  <a href="orders.html"><i class="fas fa-box-open"></i>Orders</a>
  <a href="profile.html" class="active"><i class="fas fa-user"></i>Profile</a>
</div>

<script>
/* (original profile.js content unchanged) */
const DEFAULT_RATES = { KSH:1, USD:0.0075, EUR:0.0068, GBP:0.0058 };
const SYMBOLS = { KSH:'Ksh', USD:'$', EUR:'€', GBP:'£' };

function el(id){ return document.getElementById(id); }
function readJSON(k){ try { return JSON.parse(localStorage.getItem(k) || 'null'); } catch { return null; } }
function writeJSON(k,v){ localStorage.setItem(k, JSON.stringify(v)); }
function nowISO(){ return new Date().toISOString(); }
function safeKey(s){ return String(s||'').replace(/[^a-z0-9_\\-]/ig,'_'); }

const email = localStorage.getItem('rememberUser') || localStorage.getItem('tss_last_login');
if(!email){
  // if not logged in redirect to login page
  window.location.href = 'customer-login.html';
}

// Read rates from localStorage (admin can change)
function getRates(){
  return {
    KSH: 1,
    USD: Number(localStorage.getItem('rate_usd') || DEFAULT_RATES.USD),
    EUR: Number(localStorage.getItem('rate_eur') || DEFAULT_RATES.EUR),
    GBP: Number(localStorage.getItem('rate_gbp') || DEFAULT_RATES.GBP)
  };
}

// User record helpers
function getUser(){ return readJSON('user:' + email) || { email, name: email.split('@')[0], currency: 'KSH' }; }
function saveUser(u){ writeJSON('user:' + email, u); }

// Balance stored per-customer with currency
function getCustomerBalanceAndCurrency(){
  const amt = Number(localStorage.getItem('customer_balance_' + email) || 0);
  const cur = localStorage.getItem('customer_currency_' + email) || getUser().currency || 'KSH';
  return { amt, cur };
}
function setCustomerBalanceAndCurrency(amount, currency){
  // amount is stored in the currency unit (not KSH)
  localStorage.setItem('customer_balance_' + email, String(Math.round(Number(amount)*100)/100));
  localStorage.setItem('customer_currency_' + email, currency);
  window.dispatchEvent(new StorageEvent('storage', { key: 'customer_balance_' + email }));
}

// conversion helper: convert value 'amount' from 'fromCur' to 'toCur'
function convert(amount, fromCur, toCur){
  const rates = getRates();
  const inKsh = Number(amount) / (rates[fromCur] || 1); // amount / (1 KSH -> X) => KSH
  const out = inKsh * (rates[toCur] || 1);
  return Math.round(out * 100)/100;
}

// format
function formatAmount(amount, cur){
  return `${SYMBOLS[cur] || cur} ${Number(amount).toFixed(2)}`;
}

/* ========== UI rendering ========== */
function renderProfile(){
  const u = getUser();
  el('uName').textContent = u.name || email.split('@')[0];
  el('uEmail').textContent = u.email || email;
  if(u.avatar) el('avatarImg').src = u.avatar; else el('avatarImg').src = 'https://via.placeholder.com/92?text=You';
  el('firstName').value = u.firstName || '';
  el('lastName').value = u.lastName || '';
  el('emailField').value = u.email || email;
  el('phoneField').value = u.phone || '';
  el('countryField').value = u.country || '';
  el('tzField').value = u.timezone || '';
  // currency selects
  const balInfo = getCustomerBalanceAndCurrency();
  el('displayCurrency').value = balInfo.cur || (u.currency || 'KSH');
  el('topupCurrency').value = 'KSH';
  el('balanceDisplay').textContent = formatAmount(balInfo.amt, balInfo.cur);
  el('convertedSmall').textContent = `Equivalent (Ksh): ${convert(balInfo.amt, balInfo.cur, 'KSH').toFixed(2)}`;
  renderTxs();
  renderOrders();
  loadWorkersDropdown();
}

// transactions
function renderTxs(){
  const arr = readJSON('customer_transactions_' + email) || [];
  const wrap = el('txList'); wrap.innerHTML = '';
  if(!arr.length){ wrap.innerHTML = '<div class="small">No transactions yet</div>'; return; }
  arr.forEach(t=>{
    const div = document.createElement('div');
    div.style.padding='8px'; div.style.borderBottom='1px solid rgba(255,255,255,0.03)';
    div.innerHTML = `<div style="display:flex;justify-content:space-between"><div style="font-weight:700">${t.type}</div><div class="small">${new Date(t.when).toLocaleString()}</div></div>
      <div class="small">${t.note || ''}</div>
      <div style="margin-top:6px">${formatAmount(t.amount, t.currency)} ${t.feeKsh ? `• fee Ksh ${Number(t.feeKsh).toFixed(2)}` : ''}</div>`;
    wrap.appendChild(div);
  });
}

// orders list rendering
function renderOrders(){
  const arr = readJSON('orders_' + email) || [];
  const wrap = el('ordersList'); wrap.innerHTML = '';
  if(!arr.length){ wrap.innerHTML = '<div class="small">No orders yet</div>'; return; }
  const userCurrency = localStorage.getItem('customer_currency_' + email) || getUser().currency || 'KSH';
  arr.forEach(o=>{
    const d = document.createElement('div'); d.style.padding='8px'; d.style.borderBottom='1px solid rgba(255,255,255,0.03)';
    // total stored in KSH (totalKsh or total)
    const totalKsh = Number(o.totalKsh || o.total || 0);
    const totalConverted = convert(totalKsh, 'KSH', userCurrency);
    d.innerHTML = `<div style="display:flex;justify-content:space-between"><div><strong>${o.orderId}</strong> <span class="small">${o.shop}</span></div><div style="text-align:right"><div style="font-weight:800">${formatAmount(totalConverted, userCurrency)}</div><div class="small">${o.status||'pending'}</div></div></div>
      <div style="margin-top:8px">${(o.items||[]).map(it=>`<div>${it.name} × ${it.qty} — ${formatAmount(convert(Number(it.price)*it.qty,'KSH', userCurrency), userCurrency)}</div>`).join('')}</div>
      <div style="margin-top:8px;display:flex;gap:8px">
        ${o.status !== 'Picked' ? `<button class="btn ghost cancel-order-btn" data-id="${o.orderId}">Cancel</button>` : ''}
        ${o.pickupCode ? `<div style="margin-left:auto;color:var(--muted)">Code: <b>${o.pickupCode}</b></div>` : ''}
      </div>`;
    wrap.appendChild(d);
  });

  // wire cancel buttons
  wrap.querySelectorAll('.cancel-order-btn').forEach(b=>{
    b.addEventListener('click', (ev)=>{
      const id = ev.target.dataset.id;
      let arrNow = readJSON('orders_' + email) || [];
      const idx = arrNow.findIndex(o => o.orderId === id);
      if(idx === -1) return;
      if(arrNow[idx].status === 'Picked') return alert('Cannot cancel picked order.');
      if(!confirm('Cancel this order?')) return;
      const order = arrNow[idx];
      arrNow.splice(idx,1);
      writeJSON('orders_' + email, arrNow);
      // remove from shop_orders too
      try {
        const shopKey = 'shop_orders_' + safeKey(order.shop);
        let shopArr = readJSON(shopKey) || [];
        shopArr = shopArr.filter(o => o.orderId !== order.orderId);
        writeJSON(shopKey, shopArr);
      } catch(e){}
      pushAdminLog({ when: nowISO(), type:'order_cancelled', orderId: order.orderId, shop: order.shop, customer: email });
      renderOrders();
      alert('Order cancelled.');
    });
  });
}

// push admin log
function pushAdminLog(obj){ const arr = readJSON('admin_log') || []; arr.unshift(obj); writeJSON('admin_log', arr); }

// Top-up flow
el('topupBtn').addEventListener('click', ()=> topUp(false));
el('devTopupBtn').addEventListener('click', ()=> topUp(true));

function topUp(isDev){
  const input = Number(el('topupAmount').value || 0);
  if(!input || input <= 0) return alert('Enter an amount');
  const topupCur = el('topupCurrency').value || 'KSH';
  // convert input (in topupCur) to KSH
  const rates = getRatesFromStorage();
  const amountKsh = Math.round((input / (rates[topupCur] || 1)) * 100)/100;
  const feeKsh = isDev ? 0 : Math.round(amountKsh * 0.05 * 100)/100;
  const netKsh = Math.round((amountKsh - feeKsh) * 100)/100;
  // convert netKsh to user's display currency and add to stored balance
  const userCur = el('displayCurrency').value || getUser().currency || 'KSH';
  const netUser = convert(netKsh, 'KSH', userCur);
  const current = getCustomerBalanceAndCurrency();
  const newAmt = Math.round((Number(current.amt) + netUser) * 100)/100;
  setCustomerBalanceAndCurrency(newAmt, userCur);
  // save tx record (store original amount and feeKsh)
  const tx = { when: nowISO(), type:'topup', amount: input, currency: topupCur, amountKsh, feeKsh, creditedInUserCurrency: netUser, userCurrency: userCur, note: isDev ? 'DEV topup' : 'Top-up' };
  const txsKey = 'customer_transactions_' + email;
  let txs = readJSON(txsKey) || []; txs.unshift(tx); writeJSON(txsKey, txs);
  if(!isDev) addCompanyIncomeInKsh(feeKsh);
  pushAdminLog(Object.assign({ when: nowISO(), type:'topup', user: email }, tx));
  el('topupAmount').value = '';
  renderProfile();
  alert(`Top-up successful. Credited ${formatAmount(netUser, userCur)} (fee Ksh ${feeKsh.toFixed(2)})`);
}

function getRatesFromStorage(){
  return {
    KSH: 1,
    USD: Number(localStorage.getItem('rate_usd') || 0.0075),
    EUR: Number(localStorage.getItem('rate_eur') || 0.0068),
    GBP: Number(localStorage.getItem('rate_gbp') || 0.0058)
  };
}
function convert(amount, fromCur, toCur){
  const rates = getRatesFromStorage();
  const inKsh = Number(amount) / (rates[fromCur] || 1);
  const out = inKsh * (rates[toCur] || 1);
  return Math.round(out * 100)/100;
}
function addCompanyIncomeInKsh(v){ const cur = Number(localStorage.getItem('company_income') || 0); localStorage.setItem('company_income', String(Math.round((cur + Number(v))*100)/100)); }

// Display currency change: converts stored balance from old currency to new currency
el('displayCurrency').addEventListener('change', () => {
  const newCur = el('displayCurrency').value;
  const current = getCustomerBalanceAndCurrency();
  if(current.cur === newCur) { // just update user preference
    const u = getUser(); u.currency = newCur; saveUser(u); renderProfile(); return;
  }
  // convert current amount from current.cur => newCur
  const newAmt = convert(current.amt, current.cur, newCur);
  setCustomerBalanceAndCurrency(newAmt, newCur);
  const u = getUser(); u.currency = newCur; saveUser(u);
  pushAdminLog({ when: nowISO(), type:'currency_changed', user: email, from: current.cur, to: newCur, oldAmount: current.amt, newAmount: newAmt });
  renderProfile();
  alert(`Display currency switched to ${newCur}. Your balance was converted.`);
});

// helper to add dev credit
el('devTopupBtn').addEventListener('click', ()=> {
  const amt = Number(el('topupAmount').value || 0);
  if(!amt) return alert('Enter amount');
  // treat as KSH dev credit for simplicity
  const current = getCustomerBalanceAndCurrency();
  const newAmt = Math.round((Number(current.amt) + amt) * 100)/100;
  setCustomerBalanceAndCurrency(newAmt, current.cur);
  const tx = { when: nowISO(), type:'dev_credit', amount: amt, currency: current.cur, note:'DEV credit' };
  let txs = readJSON('customer_transactions_' + email) || []; txs.unshift(tx); writeJSON('customer_transactions_' + email, txs);
  pushAdminLog({ when: nowISO(), type:'dev_credit', user: email, amount: amt });
  el('topupAmount').value = '';
  renderProfile();
  alert('DEV credit added');
});

// Save profile
el('saveProfileBtn').addEventListener('click', saveProfile);
el('saveProfileBtnTop').addEventListener('click', saveProfile);
function saveProfile(){
  const u = getUser();
  u.firstName = el('firstName').value.trim();
  u.lastName = el('lastName').value.trim();
  u.name = [u.firstName, u.lastName].filter(Boolean).join(' ') || u.name;
  u.phone = el('phoneField').value.trim();
  u.country = el('countryField').value.trim();
  u.timezone = el('tzField').value.trim();
  saveUser(u);
  pushAdminLog({ when: nowISO(), type:'profile_saved', user: email });
  renderProfile();
  alert('Profile saved');
}

// avatar upload
el('avatarWrap').addEventListener('click', () => {
  const inp = document.createElement('input'); inp.type='file'; inp.accept='image/*';
  inp.onchange = e => {
    const f = e.target.files[0];
    if(!f) return;
    const reader = new FileReader();
    reader.onload = () => {
      const u = getUser(); u.avatar = reader.result; saveUser(u); pushAdminLog({ when: nowISO(), type:'avatar_updated', user: email }); renderProfile();
    };
    reader.readAsDataURL(f);
  };
  inp.click();
});

// export profile
el('profileExportBtn').addEventListener('click', ()=>{
  const payload = { user: readJSON('user:' + email) || {}, txs: readJSON('customer_transactions_' + email) || [], orders: readJSON('orders_' + email) || [] };
  const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download = 'profile_export_'+email+'_'+(new Date().toISOString())+'.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});

// workers dropdown (for issues panel) - minimal but present so admin UI can use
function loadWorkersDropdown(){
  // no-op for profile page; available for admin (keeps UI consistent)
}

// Menu switching
el('menuProfile').addEventListener('click', ()=> switchPanel('profile'));
el('menuWallet').addEventListener('click', ()=> switchPanel('wallet'));
el('menuOrders').addEventListener('click', ()=> switchPanel('orders'));
el('menuSecurity').addEventListener('click', ()=> switchPanel('security'));
function switchPanel(p){
  el('profileSection').style.display = p === 'profile' ? '' : 'none';
  el('walletSection').style.display = p === 'wallet' ? '' : 'none';
  el('ordersSection').style.display = p === 'orders' ? '' : 'none';
  el('securitySection').style.display = p === 'security' ? '' : 'none';
  document.querySelectorAll('.menu button').forEach(b => b.classList.remove('active'));
  if(p === 'profile') el('menuProfile').classList.add('active');
  if(p === 'wallet') el('menuWallet').classList.add('active');
  if(p === 'orders') el('menuOrders').classList.add('active');
  if(p === 'security') el('menuSecurity').classList.add('active');
}

// initialize UI
(function init(){
  const u = getUser();
  if(!u.createdAt){ u.createdAt = nowISO(); saveUser(u); }
  if(!localStorage.getItem('customer_currency_' + email)) localStorage.setItem('customer_currency_' + email, u.currency || 'KSH');
  if(!localStorage.getItem('customer_balance_' + email)) localStorage.setItem('customer_balance_' + email, '0');
  renderProfile();
})();

// listen storage for live sync
window.addEventListener('storage', (e)=>{
  if(!e.key) return;
  if(e.key.startsWith('customer_balance_') || e.key === ('customer_balance_' + email) || e.key === 'company_income' || e.key === 'last_tx_change' || e.key.startsWith('orders_') ) renderProfile();
});
</script>
</body>
</html>
