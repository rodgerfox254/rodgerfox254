<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Orders â€” Time Shop Save</title>

  <!-- Favicon (inline SVG) -->
  <link rel="icon" type="image/svg+xml"
        href="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><defs><linearGradient id='g' x1='0' x2='1'><stop offset='0' stop-color='%237b2ff7'/><stop offset='1' stop-color='%23ff6ec7'/></linearGradient></defs><rect width='100' height='100' rx='16' fill='url(%23g)'/><text x='50' y='60' font-family='Inter,Arial,sans-serif' font-weight='800' font-size='28' text-anchor='middle' fill='%23070416'>TSS</text></svg>">
  <link rel="apple-touch-icon"
        href="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 120 120'><defs><linearGradient id='g2' x1='0' x2='1'><stop offset='0' stop-color='%237b2ff7'/><stop offset='1' stop-color='%23ff6ec7'/></linearGradient></defs><rect width='120' height='120' rx='20' fill='url(%23g2)'/><text x='60' y='78' font-family='Inter,Arial,sans-serif' font-weight='800' font-size='38' text-anchor='middle' fill='%23070416'>TSS</text></svg>">
  <meta name="theme-color" content="#7b2ff7">

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700,800&display=swap" rel="stylesheet">
  <script src="https://kit.fontawesome.com/a2d9b9f0d4.js" crossorigin="anonymous"></script>
  <style>
    :root {
      --bg1:#070416;
      --accent:#7b2ff7;
      --text:#eaf3ff;
      --muted:rgba(234,243,255,0.7);
      --card-bg:rgba(255,255,255,0.04);
      --accent-grad:linear-gradient(90deg,#7b2ff7,#ff6ec7,#2be7ff);
      --active:#2be72b;
      --offline:#ff4b4b;
    }
    body {
      margin:0;
      font-family:Inter,system-ui;
      color:var(--text);
      background:var(--bg1);
      overflow-y:auto;
    }
    header {
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:14px 16px;
      border-bottom:1px solid rgba(255,255,255,0.1);
      background:rgba(7,4,22,0.9);
      position:sticky;
      top:0;
      z-index:10;
    }
    header h1 {
      margin:0;
      font-size:18px;
      background:var(--accent-grad);
      -webkit-background-clip:text;
      color:transparent;
      font-weight:700;
    }
    .back-btn {
      display:flex;
      align-items:center;
      gap:6px;
      font-size:15px;
      color:var(--muted);
      background:none;
      border:none;
      cursor:pointer;
      transition:all 0.3s;
    }
    .back-btn:hover {
      color:var(--accent);
      transform:translateX(-3px);
    }

    .order-container {
      padding:16px;
      padding-bottom:110px;
    }
    .order-item {
      background:var(--card-bg);
      border-radius:16px;
      padding:10px;
      display:flex;
      align-items:center;
      gap:12px;
      margin-bottom:12px;
    }
    .order-item img {
      width:70px;
      height:70px;
      border-radius:12px;
      object-fit:cover;
    }
    .item-info { flex:1; }
    .item-info h3 {
      margin:0;
      font-size:14px;
      font-weight:600;
    }
    .item-info p {
      margin:4px 0;
      color:var(--accent);
      font-weight:700;
      font-size:13px;
    }
    .remove-btn {
      background:#ff4b4b;
      border:none;
      border-radius:8px;
      color:#fff;
      font-size:12px;
      padding:6px 10px;
      cursor:pointer;
    }

    .total {
      text-align:right;
      font-size:15px;
      font-weight:700;
      color:var(--accent);
      margin-top:20px;
    }

    .wallet {
      background:var(--card-bg);
      border-radius:16px;
      padding:14px;
      margin:20px 16px 90px 16px;
    }
    .wallet h2 {
      font-size:16px;
      margin:0 0 10px 0;
    }
    .wallet-balance {
      font-size:15px;
      font-weight:700;
      color:var(--active);
    }
    .wallet-actions {
      display:flex;
      gap:10px;
      margin-top:10px;
    }
    .wallet-actions button {
      flex:1;
      border:none;
      border-radius:8px;
      padding:10px;
      font-weight:600;
      cursor:pointer;
      color:#fff;
    }
    .pay-now { background:var(--active); color:#071126; }

    .confirm-pickup {
      margin-top:12px;
      display:flex;
      gap:8px;
      align-items:center;
    }
    .confirm-pickup input {
      flex:1;
      padding:8px;
      border-radius:8px;
      border:1px solid rgba(255,255,255,0.06);
      background:transparent;
      color:var(--text);
    }
    .confirm-pickup button {
      padding:8px 10px;
      border-radius:8px;
      border:0;
      background:var(--accent-grad);
      color:#071126;
      font-weight:700;
      cursor:pointer;
    }

    .message {
      text-align:center;
      background:var(--card-bg);
      border-radius:16px;
      padding:20px;
      margin:20px 16px;
      display:none;
      font-weight:600;
    }

    .bottom-nav {
      position:fixed;
      bottom:0;
      width:100%;
      display:flex;
      justify-content:space-around;
      background:rgba(7,4,22,0.9);
      padding:8px 0;
      border-top:1px solid rgba(255,255,255,0.05);
      backdrop-filter:blur(10px);
    }
    .bottom-nav a {
      display:flex;
      flex-direction:column;
      align-items:center;
      font-size:12px;
      color:var(--muted);
    }
    .bottom-nav a.active { color:var(--accent); }
    .bottom-nav i { font-size:18px; margin-bottom:2px; }
  </style>
</head>
<body>

<header>
  <button class="back-btn" id="backBtn"><i class="fas fa-arrow-left"></i> Back</button>
  <h1>Orders</h1>
  <span></span>
</header>

<div class="order-container" id="orderContainer"></div>

<div class="wallet">
  <h2>Wallet</h2>
  <div class="wallet-balance">Balance: <span id="currencySymbol">Ksh</span> <span id="balance">0.00</span></div>
  <div class="wallet-actions">
    <button class="pay-now" id="payNowBtn">Pay Now</button>
  </div>

  <!-- Shopkeeper confirm pickup input (only visible when current user is owner of this shop) -->
  <div id="pickupConfirmArea" class="confirm-pickup" style="display:none">
    <input id="confirmCodeInput" placeholder="Enter pickup code" />
    <button id="confirmPickupBtn">Confirm</button>
  </div>
</div>

<div class="message" id="messageBox"></div>

<div class="bottom-nav">
  <a href="index.html"><i class="fas fa-home"></i>Home</a>
  <a href="explore.html"><i class="fas fa-compass"></i>Explore</a>
  <a href="orders.html" class="active"><i class="fas fa-box-open"></i>Orders</a>
  <a href="profile.html"><i class="fas fa-user"></i>Profile</a>
</div>

<script>
/*
 Enhanced orders.html (keeps exact look & colors; feature upgrades only):
 - Shows amounts in customer's selected display currency (reads customer_currency_<email> or user:<email>.currency)
 - Payment flow converts between user's currency and KSH correctly, deducts customer's stored balance (stored per-customer in their selected currency)
 - On successful payment: saves order with both KSH totals and customer-currency totals to orders_<customerEmail> and shop_orders_<shopKey>, credits shopkeeper balance in KSH, records company fee in company_income (KSH), writes admin_log, clears cart
 - If the current remembered user is the shop owner, the "pickup" confirm input appears; entering the pickup code marks the order as Picked on both shop_orders and orders_<customerEmail> (status set to 'Picked' and UI updates to show 'Done')
 - Listens to localStorage events to stay in sync across tabs
 - Design/colors are unchanged
*/

function safeKey(s){ return String(s||'').replace(/[^a-z0-9_\-]/ig,'_'); }
function nowISO(){ return new Date().toISOString(); }

const params = new URLSearchParams(window.location.search);
const shopName = decodeURIComponent(params.get('shop') || (localStorage.getItem('currentShop') ? (JSON.parse(localStorage.getItem('currentShop')).shopName || '') : 'unknown'));
const cartKey = 'cart_' + safeKey(shopName);
localStorage.setItem('currentShop', shopName);

let cart = JSON.parse(localStorage.getItem(cartKey) || '[]');

// determine customer email (rememberUser or prompt)
function getCurrentCustomerEmail(){
  return localStorage.getItem('rememberUser') || localStorage.getItem('tss_last_login') || null;
}

let customerEmail = getCurrentCustomerEmail();
if(!customerEmail){
  // try prompting once (original behavior); keep same UX
  const p = prompt('Enter your email to continue (or Cancel to go back):');
  if(!p){
    alert('You need to login/register to place orders.');
    window.location.href = 'customer-login.html';
  } else {
    customerEmail = p.trim().toLowerCase();
    localStorage.setItem('rememberUser', customerEmail);
  }
}

// currency helpers: rates from localStorage (admin editable)
function getRates(){
  return {
    KSH: 1,
    USD: Number(localStorage.getItem('rate_usd') || 0.0075),
    EUR: Number(localStorage.getItem('rate_eur') || 0.0068),
    GBP: Number(localStorage.getItem('rate_gbp') || 0.0058)
  };
}
const SYMBOLS = { KSH:'Ksh', USD:'$', EUR:'â‚¬', GBP:'Â£' };

function getUserCurrency(user){
  // prefer per-customer currency key, fallback to user: record currency, default KSH
  try {
    const c = localStorage.getItem('customer_currency_' + user);
    if(c) return c;
    const u = JSON.parse(localStorage.getItem('user:' + user) || '{}');
    if(u && u.currency) return u.currency;
  } catch {}
  return 'KSH';
}

function getCustomerBalanceAndCurrency(user){
  const amt = Number(localStorage.getItem('customer_balance_' + user) || 0);
  const cur = getUserCurrency(user);
  return { amt, cur };
}
function setCustomerBalanceAndCurrency(user, amount, currency){
  // store amount in customer's currency unit
  localStorage.setItem('customer_balance_' + user, String(Math.round(Number(amount)*100)/100));
  localStorage.setItem('customer_currency_' + user, String(currency));
}

// convert helpers: rates map is 1 KSH => X currency
function convertKshTo(amountKsh, toCurrency){
  const rates = getRates();
  if(toCurrency === 'KSH') return Number(amountKsh);
  const rate = rates[toCurrency] || 1;
  return Math.round((Number(amountKsh) * rate) * 100)/100;
}
function convertFromCurrencyToKsh(amount, fromCurrency){
  const rates = getRates();
  const rate = rates[fromCurrency] || 1;
  // amount (in fromCurrency) -> KSH = amount / rate
  return Math.round((Number(amount) / rate) * 100)/100;
}
function formatForUser(kshAmount, user){
  const cur = getUserCurrency(user);
  if(cur === 'KSH') return `${SYMBOLS.KSH} ${Number(kshAmount).toFixed(2)}`;
  const converted = convertKshTo(kshAmount, cur);
  return `${SYMBOLS[cur] || cur}${Number(converted).toFixed(2)} (${SYMBOLS.KSH} ${Number(kshAmount).toFixed(2)})`;
}

// DOM refs
const container = document.getElementById('orderContainer');
const balanceElem = document.getElementById('balance');
const currencySymbolEl = document.getElementById('currencySymbol');
const messageBox = document.getElementById('messageBox');
const payBtn = document.getElementById('payNowBtn');
const pickupArea = document.getElementById('pickupConfirmArea');
const confirmInput = document.getElementById('confirmCodeInput');
const confirmBtn = document.getElementById('confirmPickupBtn');

document.getElementById('backBtn').onclick = () => {
  if (shopName && shopName !== 'unknown') window.location.href = `shop.html?shop=${encodeURIComponent(shopName)}`;
  else window.location.href = 'explore.html';
};

function totalCostKsh(){
  return cart.reduce((sum,item)=> sum + (Number(item.price) * (item.qty || 1)), 0);
}

function renderCart(){
  cart = JSON.parse(localStorage.getItem(cartKey) || '[]');
  if(!cart || cart.length === 0){
    container.innerHTML = `<p style="text-align:center;margin-top:40px;">ðŸ›’ No items in your order.</p>`;
    updateBalanceDisplay();
    return;
  }
  // Render each item converting price display into user's currency
  container.innerHTML = cart.map((item,i)=>{
    // price and line sum are stored in KSH (original data)
    const lineKsh = Number(item.price) * item.qty;
    const priceDisplay = formatForUser(Number(item.price), customerEmail);
    const lineDisplay = formatForUser(lineKsh, customerEmail);
    return `
    <div class="order-item">
      <img src="${item.img || 'https://via.placeholder.com/72'}" alt="${item.name}">
      <div class="item-info">
        <h3>${item.name}</h3>
        <p>${priceDisplay} Ã— ${item.qty} = <b>${lineDisplay}</b></p>
      </div>
      <button class="remove-btn" data-i="${i}">Remove</button>
    </div>`;
  }).join('') + `<div class="total">Total: ${formatForUser(totalCostKsh(), customerEmail)}</div>`;

  // wire remove buttons
  container.querySelectorAll('.remove-btn').forEach(b => b.addEventListener('click', (e)=>{
    const i = Number(e.target.dataset.i);
    cart.splice(i,1);
    localStorage.setItem(cartKey, JSON.stringify(cart));
    renderCart();
  }));

  updateBalanceDisplay();
}

function updateBalanceDisplay(){
  if(!customerEmail){ balanceElem.textContent = '0.00'; currencySymbolEl.textContent = 'Ksh'; return; }
  const bal = getCustomerBalanceAndCurrency(customerEmail);
  // show symbol and amount in stored customer currency
  currencySymbolEl.textContent = bal.cur || getUserCurrency(customerEmail) || 'Ksh';
  balanceElem.textContent = Number(bal.amt).toFixed(2);
}

// message helper
function showMessage(msg){
  messageBox.innerHTML = msg;
  messageBox.style.display = 'block';
  setTimeout(()=> messageBox.style.display = 'none', 6000);
}

// pay flow
payBtn.addEventListener('click', () => {
  cart = JSON.parse(localStorage.getItem(cartKey) || '[]');
  if(!cart || cart.length === 0){ showMessage('No items to pay for.'); return; }
  if(!customerEmail){ showMessage('Please login to pay.'); return; }

  const totalKsh = totalCostKsh();
  const balInfo = getCustomerBalanceAndCurrency(customerEmail);
  // convert totalKsh to customer's currency for comparison
  const totalInCustomerCurrency = convertKshTo(totalKsh, balInfo.cur);

  if(Number(balInfo.amt) < Number(totalInCustomerCurrency)){
    showMessage('âš ï¸ Insufficient funds. Please add more in your Profile.');
    return;
  }

  // compute fee and shop amounts (in KSH)
  const feeKsh = Math.round(totalKsh * 0.05 * 100)/100;
  const shopKsh = Math.round((totalKsh - feeKsh) * 100)/100;

  // deduct customer's stored balance (stored in customer's currency)
  const newCustomerAmt = Math.round((Number(balInfo.amt) - Number(totalInCustomerCurrency))*100)/100;
  setCustomerBalanceAndCurrency(customerEmail, newCustomerAmt, balInfo.cur);

  // credit shopkeeper in KSH
  let ownerEmail = null;
  try {
    const shops = JSON.parse(localStorage.getItem('local_shops') || '[]');
    const s = shops.find(x => (x.shopName||x.name) === shopName);
    if(s && s.ownerEmail) ownerEmail = s.ownerEmail;
  } catch(e){}
  if(!ownerEmail){
    for(const k in localStorage){
      if(!k.startsWith('user:')) continue;
      try { const u = JSON.parse(localStorage.getItem(k)); if(u && ((u.shopName||'').toLowerCase() === shopName.toLowerCase())){ ownerEmail = u.email; break; } } catch(e){}
    }
  }
  if(ownerEmail){
    try {
      const ownerKey = 'user:' + ownerEmail;
      const raw = localStorage.getItem(ownerKey);
      if(raw){
        const u = JSON.parse(raw);
        u.balanceKsh = Number(u.balanceKsh || 0) + shopKsh;
        localStorage.setItem(ownerKey, JSON.stringify(u));
      } else {
        const bKey = 'shopkeeper_balance_' + ownerEmail;
        const prev = Number(localStorage.getItem(bKey) || 0);
        localStorage.setItem(bKey, String(Math.round((prev + shopKsh)*100)/100));
      }
    } catch(e){ console.error('credit owner', e); }
  }

  // company income (KSH)
  const prevCompany = Number(localStorage.getItem('company_income') || 0);
  localStorage.setItem('company_income', String(Math.round((prevCompany + feeKsh) * 100)/100));

  // build order object (store both KSH and customer-currency info)
  const order = {
    orderId: 'o_' + Date.now(),
    shop: shopName,
    items: cart,
    totalKsh: totalKsh,
    feeKsh: feeKsh,
    shopKsh: shopKsh,
    customerCurrency: balInfo.cur,
    totalInCustomerCurrency: Math.round(totalInCustomerCurrency * 100)/100,
    createdAt: nowISO(),
    status: 'Paid',
    pickupCode: Math.floor(100000 + Math.random()*900000).toString(),
    customerEmail
  };

  // save to customer's orders
  try {
    const key = 'orders_' + customerEmail;
    const arr = JSON.parse(localStorage.getItem(key) || '[]');
    arr.unshift(order);
    localStorage.setItem(key, JSON.stringify(arr));
  } catch(e){ console.error('save customer order', e); }

  // save to shop_orders_<shopKey>
  try {
    const key2 = 'shop_orders_' + safeKey(shopName);
    const sa = JSON.parse(localStorage.getItem(key2) || '[]');
    sa.unshift(order);
    localStorage.setItem(key2, JSON.stringify(sa));
  } catch(e){ console.error('save shop order', e); }

  // admin log
  try {
    let admin = JSON.parse(localStorage.getItem('admin_log') || '[]');
    admin.unshift({ when: nowISO(), type: 'order_placed', shop: shopName, customer: customerEmail, totalKsh, feeKsh, orderId: order.orderId });
    localStorage.setItem('admin_log', JSON.stringify(admin));
  } catch(e){}

  // clear cart
  localStorage.removeItem(cartKey);
  cart = [];
  renderCart();

  // notify other tabs
  localStorage.setItem('last_order_change', nowISO());

  showMessage(`âœ… Order successful! Confirmation code: <b>${order.pickupCode}</b><br>Items will be ready for pickup soon.`);

});

// Show pickup confirm area if current user is shop owner
function currentRememberedUser(){ return localStorage.getItem('rememberUser') || localStorage.getItem('tss_last_login') || null; }
function isCurrentUserShopOwner(shop){
  const me = currentRememberedUser();
  if(!me) return false;
  try {
    const shops = JSON.parse(localStorage.getItem('local_shops') || '[]');
    const s = shops.find(x => (x.shopName || x.name) === shop);
    if(s && s.ownerEmail === me) return true;
  } catch(e){}
  try {
    const uraw = localStorage.getItem('user:' + me);
    if(uraw){ const u = JSON.parse(uraw); if(u && (u.shopName||'').toLowerCase() === shop.toLowerCase()) return true; }
  } catch(e){}
  return false;
}

function setupPickupConfirmUI(){
  if(isCurrentUserShopOwner(shopName)){
    pickupArea.style.display = 'flex';
  } else {
    pickupArea.style.display = 'none';
  }
}

confirmBtn.addEventListener('click', ()=>{
  const code = String(confirmInput.value || '').trim();
  if(!code) return alert('Enter pickup code.');
  const shopKey = 'shop_orders_' + safeKey(shopName);
  let shopArr = JSON.parse(localStorage.getItem(shopKey) || '[]');
  const idx = shopArr.findIndex(o => (o.pickupCode === code || o.orderId === code) && o.status !== 'Picked');
  if(idx === -1) return alert('Order with that code not found or already picked.');
  // mark shop order as picked
  shopArr[idx].status = 'Picked';
  shopArr[idx].pickedAt = nowISO();
  localStorage.setItem(shopKey, JSON.stringify(shopArr));

  // update corresponding customer order(s)
  const customerOfOrder = shopArr[idx].customerEmail;
  if(customerOfOrder){
    try {
      const custKey = 'orders_' + customerOfOrder;
      const custArr = JSON.parse(localStorage.getItem(custKey) || '[]');
      const oidx = custArr.findIndex(o => o.pickupCode === code || o.orderId === shopArr[idx].orderId);
      if(oidx !== -1){
        custArr[oidx].status = 'Picked';
        custArr[oidx].pickedAt = nowISO();
        localStorage.setItem(custKey, JSON.stringify(custArr));
      }
    } catch(e){ console.error(e); }
  }

  // admin log
  try {
    let admin = JSON.parse(localStorage.getItem('admin_log') || '[]');
    admin.unshift({ when: nowISO(), type:'order_picked', shop: shopName, code, by: currentRememberedUser() || 'unknown' });
    localStorage.setItem('admin_log', JSON.stringify(admin));
  } catch(e){}

  // signal other tabs
  localStorage.setItem('last_order_change', nowISO());

  alert('Order marked as Picked. Customer and shop status updated.');
  confirmInput.value = '';
  renderCart();
});

// keep in sync with balance changes elsewhere and status changes
window.addEventListener('storage', (e)=>{
  if(!e.key) return;
  if(e.key.startsWith('customer_balance_') || e.key === ('customer_balance_' + customerEmail) || e.key === 'last_order_change' || e.key.startsWith('orders_') || e.key.startsWith('shop_orders_') || e.key === cartKey){
    updateBalanceDisplay();
    cart = JSON.parse(localStorage.getItem(cartKey) || '[]');
    renderCart();
  }
});

// initial setup
renderCart();
updateBalanceDisplay();
setupPickupConfirmUI();
</script>
</body>
</html>
