<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>View Shop ‚Äî Time Shop Save</title>

  <!-- Favicon Option A ‚Äî Elegant gradient rounded-square with TSS -->
  <link rel="icon" type="image/svg+xml"
        href="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><defs><linearGradient id='g' x1='0' x2='1'><stop offset='0' stop-color='%237b2ff7'/><stop offset='1' stop-color='%23ff6ec7'/></linearGradient></defs><rect width='100' height='100' rx='16' fill='url(%23g)'/><text x='50' y='60' font-family='Inter,Arial,sans-serif' font-weight='800' font-size='36' text-anchor='middle' fill='%23070416'>TSS</text></svg>">
  <link rel="apple-touch-icon"
        href="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 120 120'><defs><linearGradient id='g2' x1='0' x2='1'><stop offset='0' stop-color='%237b2ff7'/><stop offset='1' stop-color='%23ff6ec7'/></linearGradient></defs><rect width='120' height='120' rx='20' fill='url(%23g2)'/><text x='60' y='78' font-family='Inter,Arial,sans-serif' font-weight='800' font-size='44' text-anchor='middle' fill='%23070416'>TSS</text></svg>">
  <meta name="theme-color" content="#7b2ff7">

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700,800&display=swap" rel="stylesheet">
  <script src="https://kit.fontawesome.com/a2d9b9f0d4.js" crossorigin="anonymous"></script>
  <style>
    :root {
      --bg1:#070416;
      --accent:#7b2ff7;
      --text:#eaf3ff;
      --muted:rgba(234,243,255,0.7);
      --card-bg:rgba(255,255,255,0.04);
      --accent-grad:linear-gradient(90deg,#7b2ff7,#ff6ec7,#2be7ff);
      --active:#2be72b;
      --offline:#ff4b4b;
    }
    body {
      margin:0;
      font-family:Inter,system-ui;
      color:var(--text);
      background:var(--bg1);
      overflow-y:auto;
    }

    header {
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:14px 16px;
      border-bottom:1px solid rgba(255,255,255,0.1);
      background:rgba(7,4,22,0.9);
      position:sticky;
      top:0;
      z-index:10;
    }
    header h1 {
      margin:0;
      font-size:18px;
      background:var(--accent-grad);
      -webkit-background-clip:text;
      color:transparent;
      font-weight:700;
    }
    .back-btn {
      display:flex;
      align-items:center;
      gap:6px;
      font-size:15px;
      color:var(--muted);
      background:none;
      border:none;
      cursor:pointer;
      transition:all 0.3s;
    }
    .back-btn:hover {
      color:var(--accent);
      transform:translateX(-3px);
    }

    .notice {
      text-align:center;
      background:var(--card-bg);
      padding:10px;
      color:var(--accent);
      font-weight:600;
      border-bottom:1px solid rgba(255,255,255,0.1);
    }

    .shop-info {
      padding:16px;
      text-align:center;
    }
    .shop-info h2 {
      margin:0;
      font-size:20px;
      font-weight:700;
      background:var(--accent-grad);
      -webkit-background-clip:text;
      color:transparent;
    }
    .shop-info p {
      margin:8px 0;
      color:var(--muted);
    }

    .status {
      display:inline-flex;
      align-items:center;
      gap:6px;
      margin-top:8px;
      font-weight:600;
      color:var(--muted);
    }
    .dot {
      width:10px;
      height:10px;
      border-radius:50%;
    }

    .product-grid {
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(150px,1fr));
      gap:12px;
      padding:16px;
      padding-bottom:100px;
    }
    .product-card {
      background:var(--card-bg);
      border-radius:16px;
      overflow:hidden;
      transition:transform 0.3s;
      position:relative;
    }
    .product-card:hover {
      transform:translateY(-3px);
    }
    .product-card img {
      width:100%;
      height:130px;
      object-fit:cover;
    }
    .product-details {
      padding:10px;
    }
    .product-details h3 {
      margin:0;
      font-size:14px;
      font-weight:600;
      color:var(--text);
      display:flex;
      align-items:center;
      gap:8px;
      justify-content:space-between;
    }
    .product-details p {
      margin:4px 0;
      color:var(--accent);
      font-weight:700;
      font-size:13px;
    }

    .status-notice {
      text-align:center;
      background:var(--card-bg);
      border-radius:12px;
      padding:10px;
      margin:10px auto;
      max-width:320px;
      display:none;
      font-weight:600;
      color:var(--text);
    }

    .bottom-nav {
      position:fixed;
      bottom:0;
      width:100%;
      display:flex;
      justify-content:space-around;
      background:rgba(7,4,22,0.9);
      padding:8px 0;
      border-top:1px solid rgba(255,255,255,0.05);
      backdrop-filter:blur(10px);
    }
    .bottom-nav a {
      display:flex;
      flex-direction:column;
      align-items:center;
      font-size:12px;
      color:var(--muted);
    }
    .bottom-nav a.active { color:var(--accent); }
    .bottom-nav i { font-size:18px; margin-bottom:2px; }
    .sold-tag { font-weight:800; color:var(--offline); margin-left:6px; font-size:12px; }
  </style>
</head>
<body>

<header>
  <button class="back-btn" id="backBtn"><i class="fas fa-arrow-left"></i> Back</button>
  <h1>View Shop</h1>
  <span></span>
</header>

<div class="notice">üëÅÔ∏è You‚Äôre viewing your shop as customers see it</div>

<div class="shop-info">
  <h2 id="shopName">Your Shop</h2>
  <p id="shopDesc">A preview of how your shop and products appear to customers.</p>
  <div class="status">
    <div class="dot" id="statusDot"></div>
    <span id="statusText">Inactive</span>
  </div>
</div>

<div id="statusNotice" class="status-notice"></div>

<div class="product-grid" id="productGrid" aria-live="polite"></div>

<div class="bottom-nav">
  <a href="index.html"><i class="fas fa-home"></i>Home</a>
  <a href="view.html" class="active"><i class="fas fa-store"></i>View</a>
  <a href="shopkeeper.html"><i class="fas fa-user-cog"></i>Shopkeeper</a>
</div>

<script>
/*
 Updated view.html logic:
 - Keep exactly the same design, layout and arrangement.
 - Link to canonical data sources used by the rest of the app:
     - Shop meta: local_shops -> shop_<shopName> -> user:* records (precedence)
     - Products: shop_products_<safeKey(shopName)> (primary). Fallback to old shopkeeper keys for compatibility.
 - Display price converted into current signed-in customer's display currency if available (customer_currency_<email>) using admin rates.
 - Show "SOLD OUT" indicator in-line (text) when stock <= 0 without changing layout structure.
 - Listen to storage events for live sync (local_shops, shop_products_*, user:, last_products_change, last_order_change, admin_log).
 - No cart, no buying, no add-to-cart controls. Read-only preview only.
*/

function safeKey(s){ return String(s||'').replace(/[^a-z0-9_\\-]/ig,'_'); }
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
function nowISO(){ return new Date().toISOString(); }

const params = new URLSearchParams(window.location.search);
const providedShop = params.get('shop') || '';
// prefer explicit shop query param, else fallback to currentShop stored
const SHOP = decodeURIComponent((providedShop && providedShop.trim()) ? providedShop : (localStorage.getItem('currentShop') ? (JSON.parse(localStorage.getItem('currentShop')).shopName || '') : ''));

// if still not defined, try shopkeeper_shopName key for backward compatibility
if(!SHOP) {
  const compat = localStorage.getItem('shopkeeper_shopName') || '';
  if(compat) { SHOP = compat; }
}

if(!SHOP){
  document.body.innerHTML = '<div style="padding:40px;text-align:center;color:var(--text)">No shop specified.</div>';
  throw new Error('No shop specified');
}

/* ----- Currency / price helpers ----- */
const SYMBOLS = { KES:'Ksh', USD:'$', EUR:'‚Ç¨' };
function getRates(){
  return {
    KES: 1,
    USD: Number(localStorage.getItem('rate_usd') || 0.0075),
    EUR: Number(localStorage.getItem('rate_eur') || 0.0068)
  };
}

// Determine display currency for the currently remembered user (customer) if any
function getUserCurrency(){
  const email = localStorage.getItem('rememberUser') || localStorage.getItem('tss_last_login') || null;
  if(!email) return 'KES';
  const c = localStorage.getItem('customer_currency_' + email) || null;
  if(c) return c;
  try { const u = JSON.parse(localStorage.getItem('user:' + email) || '{}'); if(u && u.currency) return u.currency; } catch(e){}
  return 'KES';
}

function formatPriceKsh(kshAmount){
  const cur = getUserCurrency();
  if(cur === 'KES') return `${SYMBOLS.KES} ${Number(kshAmount).toFixed(2)}`;
  const rate = getRates()[cur] || 1;
  const converted = Number(kshAmount) * rate;
  return `${SYMBOLS[cur]}${Number(converted).toFixed(2)} (${SYMBOLS.KES} ${Number(kshAmount).toFixed(2)})`;
}

/* ----- Data loaders (precedence) ----- */
function loadShopMeta(name){
  // 1) local_shops
  try {
    const list = JSON.parse(localStorage.getItem('local_shops') || '[]');
    const found = list.find(s => String((s.shopName||s.name||'')).toLowerCase() === String(name).toLowerCase());
    if(found) return normalizeMeta(found);
  } catch(e){}
  // 2) shop_<name>
  try {
    const s = JSON.parse(localStorage.getItem('shop_' + name) || 'null');
    if(s) return normalizeMeta(s);
  } catch(e){}
  // 3) user:* records
  for(const k in localStorage){
    if(!k.startsWith('user:')) continue;
    try {
      const u = JSON.parse(localStorage.getItem(k));
      if(u && (u.shopName||'').toLowerCase() === name.toLowerCase()){
        return normalizeMeta({
          shopName: u.shopName,
          category: u.category || '',
          logo: u.logo || '',
          status: u.shopActive ? 'Active' : (u.status || 'Inactive'),
          desc: u.description || ''
        });
      }
    } catch(e){}
  }
  return null;
}

function normalizeMeta(raw){
  return {
    shopName: raw.shopName || raw.name || '',
    category: raw.category || '',
    logo: raw.logo || raw.image || '',
    status: (raw.status && typeof raw.status === 'string') ? raw.status : (raw.shopActive ? 'Active' : (raw.status || 'Inactive')),
    desc: raw.desc || raw.description || ''
  };
}

// Products: prefer shop_products_<safeKey(SHOP)>, fallback to older shopkeeper_products key or shop_<name>.products
function loadProducts(name){
  try {
    const key = 'shop_products_' + safeKey(name);
    const arr = JSON.parse(localStorage.getItem(key) || '[]');
    if(arr && arr.length) return normalizeProducts(arr);
  } catch(e){}
  // fallback: shopkeeper_products (legacy)
  try {
    const legacy = JSON.parse(localStorage.getItem('shopkeeper_products') || '[]');
    if(legacy && legacy.length) return normalizeProducts(legacy);
  } catch(e){}
  // fallback: meta.products
  try {
    const meta = JSON.parse(localStorage.getItem('shop_' + name) || 'null');
    if(meta && meta.products && meta.products.length) return normalizeProducts(meta.products);
  } catch(e){}
  return [];
}

function normalizeProducts(arr){
  return arr.map(p => {
    // accept p.image or p.img; price in various keys; stock in p.stock
    return {
      id: p.id || p.productId || ('p_'+Math.random().toString(36).slice(2,8)),
      name: p.name || p.title || '',
      img: p.image || p.img || p.photo || '',
      priceKsh: Number(p.price || p.priceKsh || p.price_ksh || p.priceKES || 0),
      stock: Number(p.stock || p.qty || p.quantity || 0),
      sku: p.sku || ''
    };
  });
}

/* ----- Render logic (DO NOT change layout) ----- */
function renderShop(){
  const meta = loadShopMeta(SHOP);
  if(meta){
    document.getElementById('shopName').textContent = meta.shopName || SHOP;
    document.getElementById('shopDesc').textContent = meta.desc || meta.category || '';
    const active = String(meta.status || '').toLowerCase() === 'active' || meta.shopActive === true;
    const statusDot = document.getElementById('statusDot');
    const statusText = document.getElementById('statusText');
    const statusNotice = document.getElementById('statusNotice');
    if(active){
      statusDot.style.background = 'var(--active)';
      statusText.textContent = 'Active';
      statusText.style.color = 'var(--active)';
      statusNotice.style.display = 'block';
      statusNotice.style.background = 'rgba(43,231,43,0.08)';
      statusNotice.style.color = 'var(--active)';
      statusNotice.textContent = 'üü¢ Your shop is currently active and visible to customers.';
    } else {
      statusDot.style.background = 'var(--offline)';
      statusText.textContent = 'Inactive';
      statusText.style.color = 'var(--offline)';
      statusNotice.style.display = 'block';
      statusNotice.style.background = 'rgba(255,75,75,0.08)';
      statusNotice.style.color = 'var(--offline)';
      statusNotice.textContent = 'üî¥ Your shop is inactive and hidden from customers.';
    }
  } else {
    // fallback: minimal
    document.getElementById('shopName').textContent = SHOP;
    document.getElementById('shopDesc').textContent = 'No shop details';
    document.getElementById('statusDot').style.background = 'var(--offline)';
    document.getElementById('statusText').textContent = 'Inactive';
    document.getElementById('statusNotice').style.display = 'none';
  }

  const products = loadProducts(SHOP);
  const grid = document.getElementById('productGrid');
  if(!products || !products.length){
    grid.innerHTML = `<p style="grid-column:1/-1;text-align:center;color:var(--muted);">No products available.</p>`;
    return;
  }

  // Build HTML exactly as original structure (image + product-details)
  grid.innerHTML = products.map(p => {
    // show sold indicator in-line (small text) if stock <= 0 to avoid changing layout structure
    const soldText = (Number(p.stock || 0) <= 0) ? `<span class="sold-tag">SOLD OUT</span>` : '';
    return `
      <div class="product-card" data-id="${escapeHtml(p.id)}">
        <img src="${escapeHtml(p.img || 'https://via.placeholder.com/400')}" alt="${escapeHtml(p.name)}">
        <div class="product-details">
          <h3>${escapeHtml(p.name)} ${soldText}</h3>
          <p>${formatPriceKsh(p.priceKsh)}</p>
        </div>
      </div>
    `;
  }).join('');
}

/* ----- format price according to signed-in customer's display currency ----- */
function getDisplayCurrency(){
  const email = localStorage.getItem('rememberUser') || localStorage.getItem('tss_last_login') || null;
  if(!email) return 'KES';
  const cur = localStorage.getItem('customer_currency_' + email) || null;
  if(cur) return cur;
  try { const u = JSON.parse(localStorage.getItem('user:' + email) || '{}'); if(u && u.currency) return u.currency; } catch(e){}
  return 'KES';
}
function formatPriceKsh(ksh){
  const cur = getDisplayCurrency();
  const rates = getRates();
  if(cur === 'KES') return `Ksh ${Number(ksh).toFixed(2)}`;
  const rate = rates[cur] || 1;
  const converted = Number(ksh) * rate;
  return `${cur} ${Number(converted).toFixed(2)} (Ksh ${Number(ksh).toFixed(2)})`;
}

/* ----- Storage listeners to keep preview live ----- */
window.addEventListener('storage', (e) => {
  if(!e.key) return;
  const watchedPrefixes = ['local_shops','shop_products_','shop_','user:','last_products_change','last_shop_change','last_order_change','admin_log'];
  for(const p of watchedPrefixes){
    if(e.key === p || e.key.startsWith(p)){
      setTimeout(renderShop, 80);
      return;
    }
  }
});

/* ----- Initial render and wiring ----- */
document.getElementById('backBtn').addEventListener('click', ()=> window.location.href = 'shopkeeper.html');
renderShop();
</script>

</body>
</html>
