<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Profile — Time Shop Save</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
<script src="https://kit.fontawesome.com/a2d9b9f0d4.js" crossorigin="anonymous"></script>
<style>
  /* --- exact styling preserved from your design --- */
  :root{ --bg1:#070416; --g1:#7b2ff7; --g2:#ff6ec7; --g3:#2be7ff; --accent-grad: linear-gradient(90deg,var(--g1),var(--g2),var(--g3)); --text:#eaf3ff; --muted:rgba(234,243,255,0.65); --card-bg: rgba(255,255,255,0.03); --card-shadow: 0 10px 40px rgba(0,0,0,0.6); --active:#2be72b; }
  html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial;background:var(--bg1);color:var(--text);}
  *{box-sizing:border-box} a{color:inherit;text-decoration:none}
  header{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid rgba(255,255,255,0.06);background:rgba(7,4,22,0.92);position:sticky;top:0;z-index:20}
  .logo {display:flex;gap:12px;align-items:center}
  .logo-mark{width:46px;height:46px;border-radius:10px;background:var(--accent-grad);display:flex;align-items:center;justify-content:center;font-weight:800;color:#071126}
  header h1{margin:0;font-size:16px;background:var(--accent-grad);-webkit-background-clip:text;color:transparent}
  .top-actions{display:flex;align-items:center;gap:10px}
  .menu-btn{background:transparent;border:0;color:var(--muted);cursor:pointer;padding:8px;border-radius:10px}
  .menu-dropdown{position:absolute;right:12px;top:64px;background:var(--card-bg);border-radius:12px;padding:8px;box-shadow:var(--card-shadow);border:1px solid rgba(255,255,255,0.04);display:none;min-width:200px;z-index:60}
  .menu-dropdown.show{display:block}
  .menu-dropdown button{width:100%;text-align:left;background:transparent;border:0;color:var(--text);padding:8px;border-radius:8px;cursor:pointer}
  .menu-dropdown button:hover{background:rgba(255,255,255,0.02)}
  main{padding:16px;padding-bottom:120px;max-width:980px;margin:0 auto}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  @media (max-width:880px){ .grid{grid-template-columns:1fr} }
  .card{background:var(--card-bg);padding:18px;border-radius:12px;box-shadow:var(--card-shadow);border:1px solid rgba(255,255,255,0.03)}
  .avatar{width:92px;height:92px;border-radius:16px;background:rgba(255,255,255,0.03);display:flex;align-items:center;justify-content:center;overflow:hidden;border:2px solid rgba(255,255,255,0.06)}
  .avatar img{width:100%;height:100%;object-fit:cover}
  .btn{background:var(--accent-grad);border:0;padding:10px 12px;border-radius:10px;color:#071126;font-weight:700;cursor:pointer}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--text)}
  .wallet-balance{font-weight:800;color:var(--active);font-size:18px;margin-top:8px}
  .wallet-controls{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}
  .orders-list{display:flex;flex-direction:column;gap:12px;max-height:56vh;overflow:auto;padding-right:6px}
  footer.bottom-note{position:fixed;left:0;right:0;bottom:0;background:rgba(7,4,22,0.95);padding:8px 16px;border-top:1px solid rgba(255,255,255,0.04);text-align:center;color:var(--muted);font-size:13px}
</style>
</head>
<body>
  <header>
    <div class="logo">
      <div class="logo-mark">TSS</div>
      <h1>Time Shop Save</h1>
    </div>

    <div class="top-actions">
      <div style="position:relative">
        <button class="menu-btn" id="menuBtn" title="Account menu"><i class="fas fa-ellipsis-v"></i></button>
        <div class="menu-dropdown" id="menuDropdown" aria-hidden="true">
          <button id="editProfileBtn_menu">Edit profile</button>
          <button id="exportProfileBtn">Export profile</button>
          <button id="logoutBtn">Logout</button>
        </div>
      </div>
    </div>
  </header>

  <main>
    <div id="contentArea">Loading profile…</div>
  </main>

  <footer class="bottom-note">
    <a href="index.html" style="color:var(--muted)">Home</a> ·
    <a href="explore.html" style="color:var(--muted)">Explore</a> ·
    <a href="orders.html" style="color:var(--muted)">Orders</a> ·
    <a href="profile.html" style="color:var(--muted)">Profile</a>
  </footer>

<!-- Firebase modular SDK (v9+) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
  import { getFirestore, doc, onSnapshot, getDoc, updateDoc, runTransaction, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

  // ---------- CONFIG: replace with your Firebase config ----------
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT.firebaseapp.com",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_PROJECT.appspot.com",
    messagingSenderId: "YOUR_SENDER_ID",
    appId: "YOUR_APP_ID"
  };
  // ----------------------------------------------------------------

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const contentArea = document.getElementById('contentArea');
  const menuBtn = document.getElementById('menuBtn');
  const menuDropdown = document.getElementById('menuDropdown');
  const logoutBtn = document.getElementById('logoutBtn');

  // toggle menu
  menuBtn.addEventListener('click', ()=> {
    menuDropdown.classList.toggle('show');
    menuDropdown.setAttribute('aria-hidden', !menuDropdown.classList.contains('show'));
  });
  document.addEventListener('click', e => { if(!menuDropdown.contains(e.target) && e.target !== menuBtn) menuDropdown.classList.remove('show'); });

  // listen for auth state
  onAuthStateChanged(auth, async (user) => {
    if(!user) {
      // not signed in -> redirect to login
      window.location.href = 'customer-login.html?redirect=profile';
      return;
    }
    // user is signed in
    initProfile(user);
  });

  // initialize profile UI and real-time updates
  let unsubUserDoc = null;
  async function initProfile(firebaseUser){
    const uid = firebaseUser.uid;
    const userDocRef = doc(db, 'users', uid);

    // render base UI while we wait for data
    contentArea.innerHTML = `<div class="card" style="max-width:760px;margin:12px auto">Loading account…</div>`;

    // realtime listener to keep balance and profile live
    if(unsubUserDoc) unsubUserDoc();
    unsubUserDoc = onSnapshot(userDocRef, snap => {
      if(!snap.exists()){
        // if no user doc yet - create minimal doc
        createMinimalUserDoc(firebaseUser);
        return;
      }
      const userData = snap.data();
      renderProfileFromFirestore(uid, userData);
    }, err => {
      console.error('user doc listener error', err);
    });
  }

  // create user doc if missing
  async function createMinimalUserDoc(firebaseUser){
    const r = {
      name: firebaseUser.displayName || (firebaseUser.email || '').split('@')[0],
      email: firebaseUser.email || '',
      phone: firebaseUser.phoneNumber || '',
      role: 'customer',
      balance: 0,
      createdAt: serverTimestamp()
    };
    await updateDoc(doc(db,'users',firebaseUser.uid), r).catch(async (e)=>{
      // if update fails because doc missing, create
      try { await addDoc(collection(db,'users'), {...r, uid: firebaseUser.uid}); } catch(e2){ console.error(e2); }
    });
  }

  // render profile UI from Firestore doc
  function renderProfileFromFirestore(uid, user){
    // preserve exact design/layout while injecting live values
    contentArea.innerHTML = `
      <div class="grid" style="max-width:980px;margin:12px auto">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
            <div style="display:flex;gap:12px;align-items:center">
              <div class="avatar" id="avatarWrap"><img id="avatarImg" src="" alt="avatar"></div>
              <div class="profile-meta">
                <h2 id="profileName">${escapeHtml(user.name || '')}</h2>
                <p id="profileEmail" class="small muted">${escapeHtml(user.email || '')}</p>
                <div id="profileRole" class="small-muted">${escapeHtml((user.role || 'customer').toUpperCase())}</div>
              </div>
            </div>
            <div style="text-align:right">
              <div class="small-muted">Member since</div>
              <div id="memberSince" class="small muted">${user.createdAt && user.createdAt.toDate ? user.createdAt.toDate().toLocaleDateString() : ''}</div>
            </div>
          </div>

          <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px">
            <label class="btn ghost" style="display:inline-flex;align-items:center;gap:8px;cursor:pointer">
              <i class="fas fa-image"></i>
              <input id="uploadProfile" type="file" accept="image/*" style="display:none">
              Upload profile
            </label>
            <button class="btn" id="editProfileBtn">Edit Profile</button>
            <button class="btn ghost" id="exportProfileBtn2">Export</button>
          </div>

          <hr style="border:none;border-top:1px solid rgba(255,255,255,0.03);margin:12px 0">

          <div>
            <div class="small-muted">Wallet</div>
            <div class="wallet-balance">Ksh <span id="walletBalance">${Number(user.balance||0).toLocaleString()}</span></div>

            <div class="wallet-controls" style="margin-top:10px">
              <input id="addAmount" type="number" placeholder="Amount Ksh" style="padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:var(--text);width:140px">
              <input id="addPhone" type="tel" placeholder="Phone (for STK)" style="padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:var(--text);width:150px">
              <button class="btn" id="addFundsBtn">Add Funds (STK)</button>
              <!-- quick dev button to credit instantly for testing (remove in production) -->
              <button class="btn ghost" id="devCreditBtn" title="DEV: credit directly (testing)">DEV credit</button>
            </div>

            <div style="margin-top:10px">
              <div class="small-muted">Transactions</div>
              <div class="tx-list" id="txList"></div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="section-title">
            <div>
              <div style="font-weight:800">My Orders</div>
              <div class="small-muted">Orders placed & statuses</div>
            </div>
            <div>
              <button class="btn ghost" id="clearOrdersBtn">Clear All</button>
            </div>
          </div>

          <div class="orders-list card" id="ordersList" style="padding:12px;min-height:120px"></div>

          <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn" id="refreshBtn">Refresh</button>
            <button class="btn ghost" id="exportOrdersBtn">Export orders</button>
          </div>
        </div>
      </div>
    `;

    // wire UI handlers
    document.getElementById('addFundsBtn').addEventListener('click', ()=> startStkPush(uid));
    document.getElementById('devCreditBtn').addEventListener('click', ()=> devCredit(uid));
    document.getElementById('logoutBtn').addEventListener('click', () => {
      signOutHandler();
    });

    document.getElementById('editProfileBtn').addEventListener('click', async ()=> {
      const newName = prompt('Full name:', user.name || '');
      if(newName !== null && newName.trim() !== ''){
        await updateDoc(doc(db,'users',uid), { name: newName.trim() });
      }
    });

    // load txs & orders UI (these are stored in subcollections or separate collections)
    loadTxsFirestore(uid);
    loadOrdersFirestore(uid);
  }

  // ===== STK push flow (frontend) =====
  async function startStkPush(uid){
    const amount = Number(document.getElementById('addAmount').value || 0);
    const phone = (document.getElementById('addPhone').value || '').trim();
    if(!amount || amount <= 0){ alert('Enter an amount'); return; }
    if(!/^\d{9,12}$/.test(phone.replace(/\D/g,''))){ alert('Enter phone number in international/local digits (e.g. 07... or 2547...)'); return; }

    // get ID token to identify user server-side
    const token = await auth.currentUser.getIdToken(true);

    // call your backend endpoint to initiate STK push - backend will call Daraja and listen for confirmation
    const res = await fetch('/api/stk/push', {
      method: 'POST',
      headers: { 'content-type': 'application/json', 'authorization': 'Bearer ' + token },
      body: JSON.stringify({ uid, amount, phone })
    });

    const data = await res.json().catch(()=>({ok:false,message:'invalid-response'}));
    if(!res.ok){
      alert('Failed to initiate payment: ' + (data.message || res.statusText));
      return;
    }

    // backend responds with status and possibly a checkoutRequestID or message
    alert('Payment initiated. You will receive an STK prompt on your phone. Follow it to complete payment. If successful, your wallet will be credited automatically.');
  }

  // ===== Dev credit (local quick test) =====
  async function devCredit(uid){
    const amount = Number(document.getElementById('addAmount').value || 0);
    if(!amount || amount <= 0){ alert('Enter an amount'); return; }
    // WARNING: dev route directly credits Firestore (for local testing only)
    const conf = confirm(`DEV: Add Ksh ${amount} to your wallet? (Only use in test)`);
    if(!conf) return;
    // credit using a secure cloud function in real app. Here we call a test endpoint or directly patch (for dev)
    const token = await auth.currentUser.getIdToken(true);
    const res = await fetch('/api/dev/credit', {
      method:'POST', headers:{'content-type':'application/json','authorization':'Bearer '+token},
      body: JSON.stringify({uid,amount})
    });
    if(res.ok) alert('Credited (dev).');
    else {
      const d = await res.json().catch(()=>({message:'error'}));
      alert('Failed to credit: ' + (d.message || res.statusText));
    }
  }

  // ===== sign out =====
  async function signOutHandler(){
    try {
      const a = getAuthInstance();
      await a.signOut();
      window.location.href = 'customer-login.html';
    } catch(e){ console.error(e); alert('Logout failed'); }
  }

  // ===== load transactions from Firestore (subcollection 'transactions') =====
  async function loadTxsFirestore(uid){
    const txList = document.getElementById('txList');
    if(!txList) return;
    // Try to load recent txns (you can also listen with onSnapshot for realtime)
    const snap = await getDoc(doc(db,'users',uid)); // using user doc for demo: in production you might have collection userTxns
    // For demo: show placeholder - integrate with your transactions collection
    txList.innerHTML = '<div class="small-muted" style="padding:8px">Recent transactions will appear here.</div>';
  }

  // ===== orders (demo load) =====
  async function loadOrdersFirestore(uid){
    const el = document.getElementById('ordersList');
    if(!el) return;
    el.innerHTML = '<div class="small-muted">Orders will appear here (integrate with your orders collection).</div>';
  }

  // small helper
  function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

  // expose getAuth instance for signOut usage
  function getAuthInstance(){ return auth; }

</script>
</body>
</html>
